<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Chess Game</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body>
    <div class="navbar">
        <a href="index.html">Home</a>
        <a href="#" id="rules-link">Rules</a>
        <span id="auth-section">
            <a href="login.php" id="login-link">Login</a>
            <a href="register.php" id="register-link">Register</a>
        </span>
        <span id="user-section" style="display: none;">
            <span id="user-welcome"></span>
            <a href="#" id="logout-link">Logout</a>
        </span>
    </div>
    
    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h1>Cloud Chess Rules</h1>
            
            <div class="rules-content">
                <h2>Basic Rules</h2>
                <p>Cloud Chess follows standard chess rules with the addition of special pieces and a larger 10x10 board.</p>
                
                <h2>Special Pieces</h2>
                <div class="piece-rules">
                    <div class="piece-rule">
                        <div class="piece-icon dragon-icon">
                            <img src="dragon_icon_white.png" alt="Dragon" class="rules-piece-image">
                        </div>
                        <div class="piece-description">
                            <h4>Wrath (Dragon)</h4>
                            <p>Can move 1 or 2 squares in any direction (horizontal, vertical, or diagonal). If it moves 2 squares and there's an enemy piece in the middle, it captures both pieces.</p>
                        </div>
                    </div>
                    <div class="piece-rule">
                        <div class="piece-icon">♙⇡</div>
                        <div class="piece-description">
                            <h4>Archer</h4>
                            <p>Moves like a pawn but can capture diagonally without moving. Either moves without capturing, or captures without moving.</p>
                        </div>
                    </div>
                </div>
                
                <h2>Board Layout</h2>
                <p>The game is played on a 10x10 board with the following setup:</p>
                <ul>
                    <li>Wraths (Dragons) are positioned in the corners</li>
                    <li>Archers are positioned in front of the King and Queen</li>
                    <li>All other pieces follow standard chess positioning</li>
                </ul>
                
                <div class="rules-image-container">
                    <img src="./rules.jpeg" alt="Chess Game Rules" class="rules-image">
                </div>
                
                <h2>Game Modes</h2>
                <ul>
                    <li><strong>Player vs Player:</strong> Play against another person</li>
                    <li><strong>Player vs Computer (Easy):</strong> Play against an AI that prioritizes captures</li>
                    <li><strong>Player vs Computer (Medium):</strong> Play against an AI that prioritizes captures and avoids danger</li>
                    <li><strong>Player vs Computer (Hard):</strong> Play against an AI that prioritizes safe captures, avoids danger, and makes strategic sacrifices when necessary</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="game-container">
        <div id="mode-selection" class="mode-selection">
            <h2>Welcome to Cloud Chess</h2>
            
            <div class="game-mode-options">
                <button id="vs-player" class="main-button">Player vs Player</button>
                
                <div class="computer-mode">
                    <select id="computer-difficulty" class="difficulty-select">
                        <option value="" disabled selected>Player vs Computer</option>
                        <option value="1">Easy</option>
                        <option value="2">Medium</option>
                        <option value="3">Hard</option>
                    </select>
                </div>
            </div>
            
            <!-- Add intro image below the buttons -->
            <div class="intro-image-container">
                <img src="./intro.jpeg" alt="Chess Game Introduction" class="intro-image">
            </div>

            <!-- Add this section below the intro image -->
            <div class="attribution">
                <p>Cloud Chess was inspired by the short story in <a href="https://www.amazon.com/Cloud-Chess-Lands-Saga-Adventure-ebook/dp/B019BU17VU/" target="_blank">Cloud Chess: A Cloudlands Saga Adventure</a> by Katie Pottle.</p>
                <p>Discover more books in the Cloudlands series on <a href="https://www.amazon.com/stores/Katie-Pottle/author/B01BED1W44" target="_blank">Katie Pottle's Amazon page</a>.</p>
            </div>

            <!-- Add this after the intro image container -->
            <div class="stats-container">
                <div class="stats-section">
                    <h3>Game Statistics</h3>
                    <div id="game-stats-container">
                        <p>Loading game statistics...</p>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3>Top Players</h3>
                    <div class="ranking-controls">
                        <span>Sort by (highest first):</span>
                        <select id="ranking-sort">
                            <option value="elo">ELO</option>
                            <option value="wins">Wins</option>
                            <option value="losses">Losses</option>
                        </select>
                    </div>
                    <div id="player-rankings-container">
                        <p>Loading player rankings...</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="game-board" style="display: none;">
            <div class="game-info">
                <div>Current Turn: <span id="current-turn">White</span></div>
            </div>
            <div id="board"></div>
        </div>
    </div>
    <script src="chess.js"></script>
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            fetch('check_session.php')
                .then(response => response.json())
                .then(data => {
                    console.log('Session check response:', data);
                    if (data.logged_in) {
                        // User is logged in
                        document.getElementById('auth-section').style.display = 'none';
                        document.getElementById('user-section').style.display = 'inline';
                        
                        // Get user ELO
                        fetch('get_user_info.php?user_id=' + data.user_id)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok: ' + response.status);
                                }
                                if (response.headers.get('content-length') === '0') {
                                    throw new Error('Empty response received');
                                }
                                return response.json();
                            })
                            .then(userData => {
                                console.log('User data response:', userData);
                                if (!userData || !userData.success) {
                                    throw new Error('Invalid user data response');
                                }
                                
                                // Convert ELO to number and format it
                                const elo = parseInt(userData.elo) || 1000;
                                let welcomeMsg = 'Welcome, ' + data.username + ' (ELO: ' + elo;
                                
                                // Add ranking information if available
                                if (userData.ranking && userData.total_users) {
                                    welcomeMsg += ' | Rank: ' + userData.ranking + '/' + userData.total_users;
                                }
                                
                                welcomeMsg += ')';
                                document.getElementById('user-welcome').textContent = welcomeMsg;
                            })
                            .catch(error => {
                                console.error('Error fetching user data:', error);
                                console.log('Trying fallback API endpoint...');
                                // Try the simplified endpoint
                                fetch('get_user_basic.php?user_id=' + data.user_id)
                                    .then(response => response.json())
                                    .then(userData => {
                                        if (userData && userData.success) {
                                            console.log('Fallback API response:', userData);
                                            document.getElementById('user-welcome').textContent = 
                                                'Welcome, ' + data.username + ' (ELO: ' + userData.elo + ')';
                                        } else {
                                            throw new Error('Fallback API also failed');
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Fallback API also failed:', err);
                                        console.log('Using session data only');
                                        document.getElementById('user-welcome').textContent = 
                                            'Welcome, ' + data.username + ' (ELO: ' + data.elo + ')';
                                    });
                            });
                    }
                })
                .catch(error => {
                    console.error('Error checking session:', error);
                });
            
            // Handle logout
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        }
                    });
            });
            
            // Function to update game usage statistics
            function updateGameStats(gameType) {
                const formData = new FormData();
                formData.append('game_type', gameType);
                
                fetch('update_game_stats.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Game usage updated:', data);
                    } else {
                        console.error('Failed to update game usage:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating game usage:', error);
                });
            }
            
            // Add event listeners to game mode buttons
            document.getElementById('vs-player').addEventListener('click', function() {
                updateGameStats('Player Vs Player (Local)');
                // Existing code to start the game
            });
            
            document.getElementById('computer-difficulty').addEventListener('change', function() {
                const level = this.value;
                if (level) {
                    updateGameStats('Vs Computer Level ' + level);
                    // Existing code to start the game
                }
            });

            // Function to load game statistics
            function loadGameStats() {
                fetch('get_game_stats.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const container = document.getElementById('game-stats-container');
                            
                            // Create table
                            let html = '<table class="stats-table">';
                            html += '<thead><tr><th>Game Type</th><th>Games Played</th></tr></thead>';
                            html += '<tbody>';
                            
                            data.stats.forEach(stat => {
                                html += `<tr>
                                    <td>${stat.game_type}</td>
                                    <td>${stat.number}</td>
                                </tr>`;
                            });
                            
                            html += '</tbody></table>';
                            container.innerHTML = html;
                        } else {
                            document.getElementById('game-stats-container').innerHTML = 
                                '<p>Unable to load game statistics.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading game stats:', error);
                        document.getElementById('game-stats-container').innerHTML = 
                            '<p>Error loading game statistics.</p>';
                    });
            }
            
            // Function to load player rankings
            function loadPlayerRankings(sortBy = 'elo') {
                fetch(`get_top_players.php?sort=${sortBy}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const container = document.getElementById('player-rankings-container');
                            const currentUserId = window.currentUserId || null;
                            
                            // Create table
                            let html = '<table class="stats-table">';
                            html += '<thead><tr><th>Rank</th><th>Player</th><th>ELO</th><th>Wins</th><th>Losses</th></tr></thead>';
                            html += '<tbody>';
                            
                            data.players.forEach(player => {
                                const isCurrentUser = currentUserId && player.id == currentUserId;
                                html += `<tr class="${isCurrentUser ? 'current-user' : ''}">
                                    <td class="player-rank">${player.rank}</td>
                                    <td>${player.username}</td>
                                    <td>${parseInt(player.elo) || 0}</td>
                                    <td>${parseInt(player.wins) || 0}</td>
                                    <td>${parseInt(player.losses) || 0}</td>
                                </tr>`;
                            });
                            
                            html += '</tbody></table>';
                            container.innerHTML = html;
                        } else {
                            document.getElementById('player-rankings-container').innerHTML = 
                                '<p>Unable to load player rankings.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading player rankings:', error);
                        document.getElementById('player-rankings-container').innerHTML = 
                            '<p>Error loading player rankings.</p>';
                    });
            }
            
            // Add event listener for ranking sort dropdown
            document.getElementById('ranking-sort').addEventListener('change', function() {
                loadPlayerRankings(this.value);
            });
            
            // Load stats when page loads
            loadGameStats();
            loadPlayerRankings();
            
            // Store current user ID for highlighting in rankings
            fetch('check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        window.currentUserId = data.user_id;
                    }
                });
        });
    </script>
</body>
</html> 